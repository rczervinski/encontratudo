generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Loja {
  id                    Int             @id @default(autoincrement())
  email                 String?         @unique
  telefone              String?
  senha                 String
  nome_loja             String
  slug                  String          @unique
  descricao             String?
  endereco              String?
  cidade                String
  estado                String
  cep                   String?
  latitude              Float?
  longitude             Float?
  telefone_loja         String?
  whatsapp              String?
  horario_funcionamento String?
  ativo                 Boolean         @default(true)
  plano                 String          @default("gratuito")
  criado_em             DateTime        @default(now())
  atualizado_em         DateTime        @updatedAt
  bairro                String?
  analytics             Analytics[]
  categorias            Categoria[]
  personalizacao        Json?           @db.JsonB
  produtos              Produto[]

  @@index([slug])
  @@index([cidade, estado])
  @@map("loja")
}

model Categoria {
  id        Int         @id @default(autoincrement())
  nome      String
  slug      String
  nivel     Int
  ordem     Int         @default(0)
  pai_id    Int?
  loja_id   Int
  oculto    Boolean     @default(false)
  criado_em DateTime    @default(now())
  loja      Loja        @relation(fields: [loja_id], references: [id], onDelete: Cascade)
  pai       Categoria?  @relation("SubCategorias", fields: [pai_id], references: [id], onDelete: Cascade)
  filhos    Categoria[] @relation("SubCategorias")
  produtos  Produto[]

  @@unique([loja_id, slug, nivel])
  @@index([loja_id, pai_id])
  @@map("categoria")
}

model Produto {
  id                 Int             @id @default(autoincrement())
  tipo               String          @default("produto")
  nome_produto       String
  descricao          String?
  preco              Float
  preco_promocional  Float?
  tags               String
  categoria_id       Int?
  estoque_quantidade Int?
  disponivel         Boolean         @default(true)
  bloqueado          Boolean         @default(false)
  destaque           Boolean         @default(false)
  duracao_estimada   String?
  area_atendimento   String?
  aceita_urgencia    Boolean         @default(false)
  importado_nfe      Boolean         @default(false)
  nfe_chave          String?
  loja_id            Int
  criado_em          DateTime        @default(now())
  atualizado_em      DateTime        @updatedAt
  imagens            ImagemProduto[]
  categoria          Categoria?      @relation(fields: [categoria_id], references: [id])
  loja               Loja            @relation(fields: [loja_id], references: [id], onDelete: Cascade)

  @@index([loja_id, tipo, disponivel, bloqueado])
  @@index([categoria_id])
  @@index([tipo])
  @@map("produto")
}

model ImagemProduto {
  id         Int      @id @default(autoincrement())
  produto_id Int
  url        String
  ordem      Int      @default(0)
  tamanho_kb Int
  criado_em  DateTime @default(now())
  produto    Produto  @relation(fields: [produto_id], references: [id], onDelete: Cascade)

  @@index([produto_id, ordem])
  @@map("imagem_produto")
}


model Analytics {
  id             Int      @id @default(autoincrement())
  loja_id        Int
  tipo           String
  produto_id     Int?
  termo_busca    String?
  ip_hash        String?
  user_agent     String?
  latitude       Float?
  longitude      Float?
  visualizado_em DateTime @default(now())
  loja           Loja     @relation(fields: [loja_id], references: [id], onDelete: Cascade)

  @@index([loja_id, tipo, visualizado_em])
  @@index([loja_id, produto_id])
  @@map("analytics")
}

model Sessao {
  id         Int      @id @default(autoincrement())
  loja_id    Int
  token      String   @unique
  ip         String?
  user_agent String?
  criado_em  DateTime @default(now())
  expira_em  DateTime

  @@index([token])
  @@index([loja_id])
  @@map("sessao")
}

model NotaFiscal {
  id                  Int      @id @default(autoincrement())
  loja_id             Int
  chave_acesso        String   @unique
  numero_nfe          String
  serie               String?
  fornecedor_nome     String
  fornecedor_cnpj     String?
  valor_total         Float
  quantidade_itens    Int
  processada          Boolean  @default(false)
  produtos_importados Int      @default(0)
  xml_path            String?
  criado_em           DateTime @default(now())

  @@index([loja_id, processada])
  @@index([chave_acesso])
  @@map("nota_fiscal")
}
